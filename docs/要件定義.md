要件定義書：Kitasato Nav（相模大野駅北口 ↔ 北里大学病院 バス次便表示PWA）
----------------------------------------------

### 1. 目的

相模大野駅北口 ⇄ 北里大学病院の移動において、アプリを開いた瞬間に**各方向の「次に来るバス（1便）」のみ**を表示し、タップでGoogleマップの経路案内を開けるようにする。

* * *

### 2. 前提・制約

* 形態：**PWA**

* バックエンド：**不要（フロントのみ）**

* ホスティング：**Firebase Hosting**

* データ：時刻表は**静的JSON同梱**

* UI：**平日/土曜/休日の選択ボタンなし**（自動判定）

* UI：**更新ボタンなし**（自動更新）

* 自動更新：**20秒ごと**に現在時刻ベースで再計算して表示更新

* 外部連携：Googleマップ（URLで遷移）

* * *

### 3. 対象範囲（路線・方向）

#### 3.1 停留所（固定）

* 出発地/到着地：**相模大野駅北口** ⇄ **北里大学病院・北里大学**

#### 3.2 対象系統（方向別）

**A. 相模大野駅北口 → 北里大学病院（病院・大学を経由/到着できる便）**

* 対象：**大53 / 大55 / 大59 / 大68 / 相25 /（必要なら大15も）**  
  ※相模大野駅側ののりば案内、および乗換検索の系統一覧に基づく。 ([カナチュウ](https://www.kanachu.co.jp/dia/noriba/terminal?tid=25&utm_source=chatgpt.com "「相模大野駅」のりば案内 | 利用者の皆さまへ"))

**B. 北里大学病院 → 相模大野駅北口（相模大野駅北口行として案内される便）**

* 対象：**大15 / 大25 / 大53 / 大59 / 大68**（相模大野駅北口行） ([カナチュウ](https://www.kanachu.co.jp/sp/noriba/terminal?nid=00129119&nn=1&utm_source=chatgpt.com "【北里大学病院・北里大学】のりば案内"))

* **大55は対象外**
  
  * 理由：北里大学病院ののりば案内上、大55は**「麻溝車庫行」**として掲載されており、**相模大野駅北口行の便として扱われていない**ため（誤案内リスク）。 ([カナチュウ](https://www.kanachu.co.jp/sp/noriba/terminal?nid=00129119&nn=1&utm_source=chatgpt.com "【北里大学病院・北里大学】のりば案内"))

* * *

### 4. 画面要件（1画面）

#### 4.1 ヘッダー

* アプリアイコン（バス）

* アプリ名：Kitasato Nav

* 右側に
  
  * **ダイヤ種別表示**（平日/土曜/休日）
  
  * **現在時刻 HH:mm**

#### 4.2 セクション（2つ）

1. **相模大野駅北口 発**：次便カード 1枚

2. **北里大学病院 発**：次便カード 1枚

#### 4.3 次便カード表示項目（UIは添付デザイン準拠）

* 出発時刻（大きく）

* 「出発まであとX分」＋（X≤2なら「まもなく出発」）

* 系統番号（例：大59）

* のりば（例：1番のりば / 3番のりば など）

* 到着予定時刻（例：15:26着）
  
  * **算出方法：路線ごとの概算所要時間（固定）**で `到着=出発+durationMins`

* * *

### 5. 機能要件

#### 5.1 起動時表示

* 端末時刻を取得し、ダイヤ種別（平日/土曜/休日）を自動判定

* 方向A/Bそれぞれの対象路線の時刻表から、**現在時刻に最も近い出発便を1件**抽出して表示

#### 5.2 自動更新

* 20秒ごとに「現在時刻」を更新し、次便を再計算して表示更新

* 手動操作（更新/ダイヤ切替）は提供しない

#### 5.3 Googleマップ連携

* カードタップでGoogleマップの経路案内を開く

* URL仕様（例）
  
  * `https://www.google.com/maps/dir/?api=1`
  
  * `origin` / `destination`：固定（駅↔病院）
  
  * `travelmode=transit&transit_mode=bus`
  
  * `departure_time`：選択便の出発時刻（epoch秒）

* 注意：Googleマップ側の都合で便を完全固定できない場合があるため、**出発時刻で“寄せる”**を仕様上の到達点とする

* * *

### 6. ダイヤ自動判定要件

* 平日：月〜金

* 土曜：土

* 休日：日・祝

* 祝日判定：クライアント内で完結（例：祝日JSON同梱 or holiday判定ライブラリ）

* * *

### 7. データ要件（静的JSON同梱）

#### 7.1 データ構造（例）

    {
      "SAGAMIONO_TO_KITASATO": {
        "weekday": [
          {
            "id": "S2K-59",
            "route": "大59",
            "label": "北里大学病院・北里大学 行",
            "platform": "相模大野駅北口 3番",
            "durationMins": 25,
            "times": ["06:40","07:00"]
          }
        ],
        "saturday": [],
        "holiday": []
      },
      "KITASATO_TO_SAGAMIONO": {
        "weekday": [
          {
            "id": "K2S-59",
            "route": "大59",
            "label": "相模大野駅北口 行",
            "platform": "北里大学病院 3番",
            "durationMins": 24,
            "times": ["06:55","07:25"]
          }
        ],
        "saturday": [],
        "holiday": []
      }
    }

#### 7.2 概算所要時間（固定値）

* 必須：各Tripに `durationMins` を持たせる

* 初期値は「現地体感/時刻表/経路サイト」などから設定し、必要に応じて後から調整可能にする  
  （例：Navitimeの時刻表には所要時間表示がある） ([NAVITIME](https://www.navitime.co.jp/bus/diagram/timelist?arrival=00129119&departure=00114298&line=00030249&utm_source=chatgpt.com "相模大野駅北口→北里大学病院・北里大学 - 路線バス時刻表"))

* * *

### 8. 次便抽出ロジック要件

* 入力：`now`（分単位）, `direction`, `dayType`

* 処理：
  
  1. 対象Tripを全て走査し、各 `times` を候補として展開
  
  2. `eta = (dep-now)` を 0〜24h範囲で算出（当日過ぎたら翌日扱い）
  
  3. `eta` 最小の候補を採用（同値は出発時刻→系統で安定ソート）
  
  4. 到着予定は `arr = dep + durationMins`

* * *

### 9. 非機能要件

* PWA
  
  * manifest（名称、アイコン、theme_color）
  
  * Service Workerで静的アセット＋時刻表JSONをキャッシュし、**オフラインでも次便表示可能**

* パフォーマンス
  
  * 初回表示はローカルJSON検索で即時（目標：体感1秒以内）

* セキュリティ/プライバシー
  
  * 個人情報を扱わない
  
  * 外部通信はGoogleマップ遷移のみ

* * *

### 10. デプロイ要件（Firebase Hosting）

* `build/` をHostingへデプロイ

* SPA設定（リライト）を有効化

* キャッシュ戦略（SW）で、時刻表JSON更新時は確実に更新されるようバージョニングする

* * *

### 11. 例外・エラーハンドリング

* 時刻表が空/未設定：カード代わりに「本日のデータが未設定」表示

* 次便が見つからない：翌日先頭便へフォールバック（同一ロジックで自然に決まる）

* * *


